# TOKEN: GITHUB_TOKEN (default with explicit permissions)
# PERMISSIONS: contents:read
# PURPOSE: DevOnboarder workflow automation
# COMPLIANCE: Universal Workflow Permissions Policy + No Default Token Policy v1.0
# SCOPE: Automated workflow processing

# ---
# codex-agent:
#   name: Agent.ReviewKnownErrors
#   role: Audits known error entries and escalates outdated ones
#   scope: .github/workflows/review-known-errors.yml
#   triggers: Weekly schedule
#   output: Issue when entries are outdated
# ---
name: Review Known Errors

on:
    schedule:
        - cron: "0 0 * * 0"
    workflow_dispatch:

permissions:
    issues: write

jobs:
    review:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: sersoft-gmbh/setup-gh-cli-action@v2
              with:
                  version: stable
            - name: Install PyYAML
              run: pip install PyYAML
            - name: Check for outdated entries
              id: check
              run: |
                  # terminal-output-policy: reviewed-safe - Python here-doc with quoted delimiter
                  python - <<'PY'
                  import datetime, json, yaml
                  from pathlib import Path
                  path = Path('.codex/known_errors.yaml')
                  data = yaml.safe_load(path.read_text()) or []
                  threshold = datetime.datetime.utcnow() - datetime.timedelta(days=30)
                  outdated = [e for e in data if datetime.datetime.fromisoformat(e['date_added']) < threshold and e.get('hits',0) == 0]
                  if outdated:
                      Path('outdated.json').write_text(json.dumps(outdated, indent=2))
                  PY
                  if [ -f "outdated_dependencies.txt" ] && [ -s "outdated_dependencies.txt" ]; then
                      printf "has_outdated=true\n" >> "$GITHUB_OUTPUT"
                  else
                      printf "has_outdated=false\n" >> "$GITHUB_OUTPUT"
                  fi
            - name: Escalate outdated entries
              if: steps.check.outputs.has_outdated == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # terminal-output-policy: reviewed-safe - Python here-doc with quoted delimiter
                  payload=$(python - <<'PY'
                  import json
                  from pathlib import Path
                  body = Path('outdated.json').read_text()
                  print(json.dumps({'title': 'Outdated known error entries', 'body': body}))
                  PY
                  )
                  gh workflow run notify.yml -f data="$payload"
