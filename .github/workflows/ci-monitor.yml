# ---
# codex-agent:
#   name: Agent.CiMonitor
#   role: Watches CI logs for rate-limit errors and opens an issue
#   scope: .github/workflows/ci-monitor.yml
#   triggers: Completed CI workflow runs
#   output: Issue with log excerpt
# ---
name: CI Monitor

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

permissions:
    issues: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            
            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'
            
            - name: Install yamllint
              run: pip install yamllint==1.35.1
            
            - name: Lint YAML files
              run: yamllint -c .github/.yamllint-config '.github/workflows/**/*.yml'
    report-rate-limit:
        needs: validate-yaml
        if: github.event.workflow_run.conclusion == 'failure'
        runs-on: ubuntu-latest
        steps:
            - name: Set token for CI Monitor operations
              id: set-token
              run: |
                # Multi-step token selection (using CI_ISSUE_TOKEN as per this workflow's pattern)
                if [ -n "${{ secrets.CI_ISSUE_AUTOMATION_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.CI_ISSUE_AUTOMATION_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=CI_ISSUE_AUTOMATION_TOKEN" >> $GITHUB_OUTPUT
                elif [ -n "${{ secrets.CI_ISSUE_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.CI_ISSUE_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=CI_ISSUE_TOKEN" >> $GITHUB_OUTPUT
                elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=GITHUB_TOKEN" >> $GITHUB_OUTPUT
                else
                    echo "::error::No authentication token available for CI Monitor operations!"
                    exit 1
                fi
                echo "Using token source for CI Monitor: $(cat $GITHUB_OUTPUT | grep token-source | cut -d= -f2)"

            - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e  # TAGS-SHA-PIN: actions/download-artifact@v4.2.1 (2025-xx-xx)
              if: github.event.workflow_run.conclusion == 'failure'
              with:
                  run-id: ${{ github.event.workflow_run.id }}
                  name: ci-logs
                  path: logs
            - name: Setup GitHub CLI
              uses: ./.github/actions/setup-gh-cli
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Show gh version
              run: which gh && gh --version
            - name: Check for rate-limit error
              id: check
              run: |
                  match=$(grep -iE 'rate limit|429 Too Many Requests|quota exceeded' -m1 logs/*.log || true)
                  if [ -n "$match" ]; then
                    printf -- "hit=true\n" >> "$GITHUB_OUTPUT"
                    printf -- "match=%s\n" "$match" >> "$GITHUB_OUTPUT"
                    printf -- "%s\n" "$match"
                  else
                    printf -- "hit=false\n" >> "$GITHUB_OUTPUT"
                  fi
            - name: Install PyYAML
              if: steps.check.outputs.hit == 'true'
              run: pip install PyYAML
            - name: Validate orchestration bot permissions
              run: 'bash scripts/validate-bot-permissions.sh'
            - name: Open issue on rate-limit
              if: steps.check.outputs.hit == 'true'
              env:
                  GH_TOKEN: ${{ steps.set-token.outputs.selected-token }}
              run: |
                  printf '%s\n' \
                    "Our CI run failed due to API rate limits. Matched line: ${{ steps.check.outputs.match }}." \
                    "Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" > body.md
                  jq -Rs --arg title "\ud83d\udea8 CI Rate Limit Exceeded" '{title:$title,body:.}' body.md > notify.json
                  gh workflow run notify.yml -f data="$(cat notify.json)"
