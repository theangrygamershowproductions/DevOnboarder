# shellcheck disable=SC2215
# ---
# codex-agent:
#   name: Agent.AutoFix
#   role: Automatically proposes fixes for failed CI runs
#   scope: .github/workflows/auto-fix.yml
#   triggers: Completed CI workflow runs with failures
#   output: Pull request suggesting patches
#   note: Requires `OPENAI_API_KEY` secret
#   security: Uses workflow_run trigger with trusted code checkout only
# ---
# SECURITY: This workflow uses workflow_run trigger which runs in privileged context.
# It intentionally does NOT checkout untrusted PR code to prevent code execution attacks.
# Only trusted code from the default branch is used for generating fixes.
name: Auto Fix

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
            - uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c
              with:
                  file_or_dir: ".github/workflows/**/*.yml"
                  config_file: .github/.yamllint-config
    fix:
        needs: validate-yaml
        if: github.event.workflow_run.conclusion == 'failure'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
              with:
                  fetch-depth: 0
                  # Security: Only checkout trusted code from the default branch
                  # Do not checkout untrusted PR code in privileged context
            - name: Get PR information
              id: pr-info
              env:
                  HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
                  HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
                  RUN_EVENT: ${{ github.event.workflow_run.event }}
              run: |
                  # shellcheck disable=SC2215
                  # Safely get PR information without checking out untrusted code
                  printf "head_sha=%s\n" "$HEAD_SHA" >> "$GITHUB_OUTPUT"
                  printf "head_branch=%s\n" "$HEAD_BRANCH" >> "$GITHUB_OUTPUT"
                  echo "Run triggered by:"
                  printf "%s\n" "$RUN_EVENT"
            - name: Run yamllint
              run: |
                  pip install yamllint
                  find .github/workflows \( -name "*.yml" -o -name "*.yaml" \) -print0 | xargs -0 yamllint -c .github/.yamllint-config | tee yamllint.log || true
            - name: Download CI logs
              if: github.event.workflow_run.conclusion == 'success'
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
              with:
                  run-id: ${{ github.event.workflow_run.id }}
                  name: ci-logs
                  path: logs
            - name: Ask OpenAI for YAML fix
              id: openai-yaml
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              run: |
                  # shellcheck disable=SC2215
                  # SECURITY: Use environment variable instead of direct secret reference
                  if [ -z "$OPENAI_API_KEY" ]; then
                    echo "OPENAI_API_KEY not set" >&2
                    exit 1
                  fi
                  pip install openai
                  file=$(awk -F: '/error/{print $1; exit}' yamllint.log)
                  line=$(awk -F: '/error/{print $2; exit}' yamllint.log)
                  snippet=""
                  if [ -n "$file" ]; then
                    start=$((line>5?line-5:1))
                    end=$((line+5))
                    snippet=$(sed -n "${start},${end}p" "$file" 2>/dev/null || true)
                  fi
                  export SNIPPET="$snippet"
                  # Simplified patch generation for now
                  cat > fix-ci-health.patch.diff << 'EOF'
                  diff --git a/example.yml b/example.yml
                  index 1234567..abcdefg 100644
                  --- a/example.yml
                  +++ b/example.yml
                  @@ -1,1 +1,1 @@
                  - old content
                  + new content
                  EOF
                  # Note: patch file already created above, no need to overwrite
            - name: Apply YAML patch
              run: git apply fix-ci-health.patch.diff || true
            - name: Suggest fix with OpenAI
              id: openai
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
              run: |
                  # shellcheck disable=SC2215
                  # SECURITY: Use environment variable instead of direct secret reference
                  if [ -z "$OPENAI_API_KEY" ]; then
                    echo "OPENAI_API_KEY not set" >&2
                    exit 1
                  fi
                  pip install openai
                  # Simplified suggestion generation
                  suggestion="Sample patch suggestion"
                  echo "$suggestion" > patch.diff
            - name: Apply patch
              run: git apply patch.diff
            
            - name: Configure Git identity
              run: |
                  git config user.name "devon-autofix[bot]"
                  git config user.email "devon-autofix[bot]@users.noreply.github.com"
            
            - name: Detect changes
              id: changes
              run: |
                  if git diff --quiet && git diff --cached --quiet; then
                    echo "has_changes=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "has_changes=true" >> "$GITHUB_OUTPUT"
                  fi
            
            - name: Create branch and commit
              if: steps.changes.outputs.has_changes == 'true'
              id: create_branch
              env:
                  BRANCH_NAME: auto-fix/${{ steps.pr-info.outputs.head_sha }}
              run: |
                  git checkout -b "$BRANCH_NAME"
                  git add -A
                  git commit -m "CHORE(auto-fix): apply patch from OpenAI" || echo "No changes to commit"
                  git push --set-upstream origin "$BRANCH_NAME"
                  echo "branch=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
            
            - name: Create pull request
              if: steps.changes.outputs.has_changes == 'true'
              id: create_pr
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  BRANCH="${{ steps.create_branch.outputs.branch }}"
                  PR_BODY="Automated fix generated from CI logs of run \`${{ github.event.workflow_run.id }}\`.

                  **Security Note**: This fix was generated from trusted code only.
                  Original failing commit: ${{ steps.pr-info.outputs.head_sha }}
                  Original branch: ${{ steps.pr-info.outputs.head_branch }}"
                  
                  PR_URL=$(gh pr create \
                    --head "$BRANCH" \
                    --base main \
                    --title "CHORE(auto-fix): propose fix for failed CI run" \
                    --body "$PR_BODY")
                  
                  PR_NUMBER="${PR_URL##*/}"
                  
                  echo "pull-request-url=$PR_URL" >> "$GITHUB_OUTPUT"
                  echo "pull-request-number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
                  echo "pull-request-operation=created" >> "$GITHUB_OUTPUT"
            
            - name: No changes detected
              if: steps.changes.outputs.has_changes != 'true'
              run: |
                  echo "No changes detected â€“ skipping PR creation."
