# ---
# codex-agent:
#   name: Agent.CleanupCiFailure
#   role: Closes stale ci-failure issues
#   scope: .github/workflows/cleanup-ci-failure.yml
#   triggers: Daily schedule
#   output: Closed or reported ci-failure issues
# ---
name: Cleanup CI Failure

on:
    schedule:
        - cron: "0 0 * * *"  # Daily cleanup as before
    pull_request:
        types: [closed]      # Trigger when PRs are closed (merged or not)
    workflow_run:
        workflows: ["CI"]    # Trigger after CI workflow completes
        types: [completed]

permissions:
    contents: read
    issues: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'

            - name: Install yamllint
              run: pip install yamllint==1.35.1

            - name: Lint YAML files and save log
              run: |
                  yamllint -c .github/.yamllint-config '.github/workflows/**/*.yml' | tee yamllint.log || true

            - name: Upload yamllint log
              if: always()
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # TAGS-SHA-PIN: actions/upload-artifact@v5.0.0 (2025-10-24)
              with:
                  name: yamllint-log
                  path: yamllint.log

    cleanup:
        needs: validate-yaml
        runs-on: ubuntu-latest
        permissions:
            issues: write
        steps:
            - name: Set token for authentication
              id: set-token
              run: |
                  # Multi-step token selection following Priority Matrix pattern
                  if [ -n "${{ secrets.CLEANUP_CI_FAILURE_KEY }}" ]; then
                      echo "selected-token=${{ secrets.CLEANUP_CI_FAILURE_KEY }}" >> $GITHUB_OUTPUT
                      echo "token-source=CLEANUP_CI_FAILURE_KEY" >> $GITHUB_OUTPUT
                  elif [ -n "${{ secrets.CI_BOT_TOKEN }}" ]; then
                      echo "selected-token=${{ secrets.CI_BOT_TOKEN }}" >> $GITHUB_OUTPUT
                      echo "token-source=CI_BOT_TOKEN" >> $GITHUB_OUTPUT
                  elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
                      echo "selected-token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
                      echo "token-source=GITHUB_TOKEN" >> $GITHUB_OUTPUT
                  else
                      echo "::error::No authentication token available! Please configure CLEANUP_CI_FAILURE_KEY or CI_BOT_TOKEN."
                      exit 1
                  fi
                  echo "Using token source: $(cat $GITHUB_OUTPUT | grep token-source | cut -d= -f2)"
            - name: Checkout repository
              uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
              with:
                  token: ${{ steps.set-token.outputs.selected-token }}
            - name: Install the gh cli
              uses: ./.github/actions/setup-gh-cli
              with:
                  token: ${{ steps.set-token.outputs.selected-token }}
            - name: Show gh version
              run: which gh && gh --version
            - name: Verify gh version
              run: |
                  ver=$(gh --version | head -n1 | awk '{print $3}')
                  major=${ver%%.*}
                  if [ "$major" -lt 2 ]; then
                    echo "::error::GitHub CLI v2 or higher required" >&2
                    exit 1
                  fi
            - name: Install PyYAML
              run: pip install PyYAML
            - name: Validate orchestration bot permissions
              run: 'bash scripts/validate-bot-permissions.sh'
            - name: Debug token and permissions
              run: |
                  gh auth status
                  gh api rate_limit
                  python scripts/list_open_ci_issues.py
              continue-on-error: true
            - name: Configure git authentication
              run: |
                  # Configure git to use the scoped token for authentication (Priority Matrix pattern)
                  git config --local url."https://${{ steps.set-token.outputs.selected-token }}@github.com/".insteadOf "https://github.com/"
            - name: Smart CI failure cleanup
              env:
                  GH_TOKEN: ${{ steps.set-token.outputs.selected-token }}
                  # Token source for debugging
                  TOKEN_SOURCE: ${{ steps.set-token.outputs.token-source }}
              run: |
                  mkdir -p logs

                  # Determine trigger type and handle appropriately
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    echo "Triggered by PR #${{ github.event.number }} closure"
                    if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                      echo "PR was merged - closing related CI failure issues"
                      bash scripts/manage_ci_failure_issues.sh close ${{ github.event.number }}
                    else
                      echo "PR was closed without merge - leaving CI failure issues open"
                    fi
                  elif [[ "${{ github.event_name }}" == "workflow_run" ]]; then
                    echo "Triggered by CI workflow completion"
                    if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
                      echo "CI workflow succeeded - checking for outdated failure issues"
                      # Get recent PR numbers from successful runs and clean their issues
                      gh run list --workflow=ci.yml --status=success --limit=5 --json number,headBranch | \
                        jq -r '.[] | select(.headBranch != "main") | .number' | \
                        while read -r run_id; do
                          pr_num=$(gh run view "$run_id" --json headBranch | jq -r '.headBranch' | sed 's/.*pr-//' | sed 's/-.*//')
                          if [[ "$pr_num" =~ ^[0-9]+$ ]]; then
                            echo "Cleaning issues for PR #$pr_num after successful CI"
                            bash scripts/manage_ci_failure_issues.sh close "$pr_num" || true
                          fi
                        done
                    fi
                  else
                    echo "Daily scheduled cleanup - using script for stale CI failure issues"
                    # Use the approved script for all issue management
                    bash scripts/manage_ci_failure_issues.sh list | while read -r line; do
                      if [[ "$line" =~ ^Issue\ #([0-9]+): ]]; then
                        issue_num="${BASH_REMATCH[1]}"
                        echo "Processing CI failure issue #$issue_num"
                        # Check if this is for a merged PR via issue title
                        if [[ "$line" =~ PR\ #([0-9]+) ]]; then
                          pr_num="${BASH_REMATCH[1]}"
                          pr_state=$(gh pr view "$pr_num" --json state,merged | jq -r '.state + ":" + (.merged|tostring)' 2>/dev/null || echo "UNKNOWN:false")
                          if [[ "$pr_state" == "MERGED:true" ]]; then
                            echo "Closing CI failure issue #$issue_num for merged PR #$pr_num"
                            bash scripts/manage_ci_failure_issues.sh close "$pr_num" || true
                          fi
                        else
                          echo "Found stale CI failure issue #$issue_num without PR reference"
                          # Note: Cannot close issues without PR reference using current script
                          # This would require script enhancement or manual cleanup
                        fi
                      fi
                    done
                  fi
