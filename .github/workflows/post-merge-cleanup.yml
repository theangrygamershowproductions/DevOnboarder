# ---
# codex-agent:
#   name: post_merge_cleanup
#   role: Cleans up logs and artifacts after successful merges to main
#   scope: .github/workflows/post-merge-cleanup.yml
#   triggers: Push to main branch
#   output: Cleaned workspace ready for next development cycle
# ---
name: Post-Merge Cleanup

on:
    push:
        branches:
            - main

permissions:
    contents: read
    issues: write

jobs:
    cleanup:
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - name: Set token for Post-Merge Cleanup operations
              id: set-token
              run: |
                # Multi-step token selection following Priority Matrix pattern
                if [ -n "${{ secrets.CI_ISSUE_AUTOMATION_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.CI_ISSUE_AUTOMATION_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=CI_ISSUE_AUTOMATION_TOKEN" >> $GITHUB_OUTPUT
                elif [ -n "${{ secrets.CI_BOT_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.CI_BOT_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=CI_BOT_TOKEN" >> $GITHUB_OUTPUT
                elif [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
                    echo "selected-token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
                    echo "token-source=GITHUB_TOKEN" >> $GITHUB_OUTPUT
                else
                    echo "::error::No authentication token available for Post-Merge Cleanup operations!"
                    exit 1
                fi
                echo "Using token source for Post-Merge Cleanup: $(cat $GITHUB_OUTPUT | grep token-source | cut -d= -f2)"

            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)

            - name: Set up Python
              uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c
              with:
                  python-version: "3.12"

            - name: Create virtual environment
              run: |
                  python -m venv .venv
                  source .venv/bin/activate
                  printf "VIRTUAL_ENV=%s\n" "$VIRTUAL_ENV" >> "$GITHUB_ENV"
                  printf "%s/bin\n" "$VIRTUAL_ENV" >> "$GITHUB_PATH"

            - name: Install minimal dependencies
              run: |
                  source .venv/bin/activate
                  pip install --no-cache-dir wheel

            - name: Clean accumulated logs after successful merge
              run: |
                  echo "Post-merge cleanup: Smart cleanup of accumulated artifacts"

                  # Show current log status
                  if [ -d logs ]; then
                      log_count=$(find logs -type f | wc -l)
                      log_size=$(du -sh logs 2>/dev/null | cut -f1 || echo "Unknown")
                      printf "Current logs: %s files (%s)\n" "$log_count" "$log_size"
                  fi

                  # Smart cleanup - removes temporary artifacts but preserves important logs
                  bash scripts/manage_logs.sh smart-clean

                  # Final status
                  if [ -d logs ]; then
                      remaining_count=$(find logs -type f | wc -l)
                      remaining_size=$(du -sh logs 2>/dev/null | cut -f1 || echo "Unknown")
                      printf "Smart cleanup complete: %s files remaining (%s)\n" "$remaining_count" "$remaining_size"
                  else
                      echo "No logs directory found"
                  fi

            - name: Archive important logs before cleanup
              if: always()
              run: |
                  if [ -d logs ] && [ "$(find logs -type f | wc -l)" -gt 0 ]; then
                      # Archive any remaining logs before final cleanup
                      bash scripts/manage_logs.sh archive
                      echo "Important logs archived"
                  fi

            - name: Close resolved CI failure issues
              env:
                  GH_TOKEN: ${{ steps.set-token.outputs.selected-token }}
                  COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
              run: |
                  echo "Checking for CI failure issues to close after successful merge"

                  # Get the commit message to extract PR number
                  printf "Commit message: %s\n" "$COMMIT_MESSAGE"

                  # Extract PR number from commit message (format: "PR #123" or "#123")
                  PR_NUMBER=$(printf -- "%s" "$COMMIT_MESSAGE" | grep -oE '#[0-9]+' | head -1 | sed 's/#//')

                  if [ -n "$PR_NUMBER" ]; then
                      printf "Found PR number: %s\n" "$PR_NUMBER"
                      bash scripts/manage_ci_failure_issues.sh close "$PR_NUMBER"
                  else
                      echo "No PR number found in commit message"
                  fi

            - name: Upload cleanup summary
              if: always()
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
              with:
                  name: post-merge-cleanup-summary
                  path: |
                      logs_archive_*.tar.gz
                  retention-days: 7
