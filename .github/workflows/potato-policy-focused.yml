name: Potato Policy Enforcement

permissions:
    contents: read
    issues: write

on:
    pull_request:
        paths:
            - "Potato.md"
            - ".gitignore"
            - ".dockerignore"
            - ".codespell-ignore"
    push:
        branches: [main, master]

jobs:
    potato-policy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Enforce Potato Policy with Reporting
              env:
                  # Use fine-grained token hierarchy for issue automation
                  GITHUB_TOKEN: ${{ secrets.CI_ISSUE_AUTOMATION_TOKEN || secrets.CI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  echo "ü•î Enhanced Potato Policy Enforcement with Reporting..."

                  # Run violation reporter (creates issues if violations found)
                  if bash scripts/potato_violation_reporter.sh; then
                    echo "‚úÖ Potato policy compliant"
                  else
                    echo "‚ùå Potato policy violations detected and reported"
                    exit 1
                  fi

                  # Generate audit report
                  bash scripts/generate_potato_report.sh

                  # Ensure reports directory exists for artifact upload
                  mkdir -p reports

                  # Upload audit report as artifact
                  echo "üìä Audit report generated for transparency"

            - name: Upload Potato Policy Audit Report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: potato-policy-audit-${{ github.run_number }}
                  path: reports/potato-policy-*.md
                  retention-days: 90
