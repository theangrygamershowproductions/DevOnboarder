name: Close Codex Issues

on:
  pull_request:
    types: [closed]

permissions:
  issues: write

jobs:
  close:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-gh-cli@v4
      - name: Show gh version
        run: |
          which gh
          gh --version
      - name: Close referenced Codex issues
        run: |
          echo "${{ github.event.pull_request.body }}" | grep -oE 'Fixes #[0-9]+' | sed 's/Fixes #//' > issues.txt || true
          gh_bin=$(which gh)
          for ISSUE in $(cat issues.txt); do
            AUTHOR=$($gh_bin api repos/${{ github.repository }}/issues/$ISSUE --jq '.user.login')
            if [ "$AUTHOR" = "codex[bot]" ]; then
              $gh_bin issue comment "$ISSUE" --body "Closed via merge of #${{ github.event.pull_request.number }}."
              $gh_bin issue close "$ISSUE" --reason completed
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
