# ---
# codex-agent:
#   name: Agent.SecretsAlignment
#   role: Audits environment variables for missing or extra entries
#   scope: .github/workflows/secrets-alignment.yml
#   triggers: Scheduled or failed CI audits
#   output: Issue summarizing mismatched variables
#   security: Uses workflow_run trigger with trusted code checkout only
# ---
# SECURITY: This workflow uses workflow_run trigger which runs in privileged context.
# It intentionally does NOT checkout untrusted PR code to prevent code execution attacks.
# Only trusted code from the default branch is used for auditing.
name: Secrets Alignment

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed
    schedule:
        - cron: "0 2 * * *"

permissions:
    contents: read
    issues: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: ibiqlik/action-yamllint@v3
              with:
                  file_or_dir: ".github/workflows/**/*.yml"
                  config_file: .github/.yamllint-config
    audit:
        needs: validate-yaml
        if: github.event_name == 'schedule' || github.event.workflow_run.conclusion == 'failure'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  # Security: Only checkout trusted code, not untrusted PR head
                  ref: ${{ github.sha }}
            - name: Get workflow run information
              id: workflow-info
              run: |
                  # Safely capture workflow run details without checking out untrusted code
                  echo "head_sha=${{ github.event.workflow_run.head_sha || github.sha }}" >> $GITHUB_OUTPUT
            - name: Install GitHub CLI
              uses: sersoft-gmbh/setup-gh-cli-action@v2
              with:
                  version: stable
            - name: Show gh version
              run: which gh && gh --version
            - name: Generate secrets
              run: ./scripts/generate-secrets.sh
            - name: Run secret audit
              run: |
                  env -i PATH="$PATH" bash -c 'set -a; source .env.dev; set +a; bash scripts/audit_env_vars.sh' > env_audit.log
                  cat env_audit.log
            - name: Parse results
              id: vars
              run: |
                  missing=$(awk '/^Missing variables:/{flag=1;next}/^$/{flag=0}flag' env_audit.log | tr '\n' ',' | sed 's/,$//')
                  extras=$(awk '/^Extra variables:/{flag=1;next}flag' env_audit.log | grep -v -E '^(PATH|PWD|SHLVL|_)$' | tr '\n' ',' | sed 's/,$//')
                  echo "missing=$missing" >> "$GITHUB_OUTPUT"
                  echo "extras=$extras" >> "$GITHUB_OUTPUT"
            - name: Install PyYAML
              if: steps.vars.outputs.missing != '' || steps.vars.outputs.extras != ''
              run: pip install PyYAML
            - name: Verify bot permission
              if: steps.vars.outputs.missing != '' || steps.vars.outputs.extras != ''
              run: 'bash scripts/check-bot-permissions.sh orchestration_bot "issues: write"'
            - name: Create issue
              if: steps.vars.outputs.missing != '' || steps.vars.outputs.extras != ''
              run: |
                  cat > body.md <<'BODY'
                    ## Missing variables
                    ${{ steps.vars.outputs.missing }}

                    ## Extra variables
                    ${{ steps.vars.outputs.extras }}

                    - [ ] I manually reviewed the variables against [agents/index.md](../../agents/index.md)
                  BODY
                  jq -Rs --arg title "Secrets misaligned in CI for ${{ steps.workflow-info.outputs.head_sha }}" '{title:$title,body:.}' body.md > notify.json
                  gh workflow run notify.yml -f data="$(cat notify.json)"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
