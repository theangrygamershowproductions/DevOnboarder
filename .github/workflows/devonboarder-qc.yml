name: DevOnboarder Quality Control

# Enforce honest QC gates - no fake green lights
# Blocks PRs if coverage <95% or tests fail
#
# IMPORTANT: This workflow ALWAYS runs on PRs (no path filter) to ensure
# the required check context is created. Docs-only PRs get a fast noop success.
# This prevents branch protection bypass for docs-only changes.

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
    paths:
      - 'backend/**'
      - 'bot/**'
      - 'frontend/**'
      - 'scripts/**'
      - 'tests/**'
      - 'requirements*.txt'
      - '.github/workflows/devonboarder-qc.yml'
  pull_request:
    branches:
      - main
    # NOTE: No paths filter - always run to provide required check context

jobs:
  qc-gate-minimum:
    name: QC Gate (Required - Basic Sanity)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
    - name: Checkout repository
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
      with:
        fetch-depth: 0

    - name: Detect code changes
      id: changes
      run: |
        # Detect if code files changed (vs docs-only PR)
        # Compare against base branch for PRs, or HEAD~1 for pushes
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE="${{ github.event.pull_request.base.sha }}"
        else
          BASE="HEAD~1"
        fi

        # Check for code-relevant changes
        CODE_PATHS="backend/ bot/ frontend/ scripts/ tests/ requirements"
        CODE_CHANGED="false"

        for path in $CODE_PATHS; do
          if git diff --name-only "$BASE" HEAD 2>/dev/null | grep -q "^${path}"; then
            CODE_CHANGED="true"
            break
          fi
        done

        echo "code_changed=$CODE_CHANGED" >> $GITHUB_OUTPUT
        echo "Code changed: $CODE_CHANGED"

        if [ "$CODE_CHANGED" = "false" ]; then
          echo ""
          echo "No code changes detected - docs/config-only PR"
          echo "QC Gate will pass with noop success"
        fi

    - name: Noop success for docs-only PR
      if: steps.changes.outputs.code_changed == 'false'
      run: |
        echo ""
        echo "=========================================="
        echo "QC GATE: DOCS-ONLY PR (NOOP SUCCESS)"
        echo "=========================================="
        echo ""
        echo "No code changes detected in this PR."
        echo "Skipping full QC validation - docs/config changes only."
        echo ""
        echo "Changed paths do not include:"
        echo "  - backend/**"
        echo "  - bot/**"
        echo "  - frontend/**"
        echo "  - scripts/**"
        echo "  - tests/**"
        echo "  - requirements*.txt"
        echo ""
        echo "QC Gate passes automatically for non-code PRs."
        echo ""

    - name: Set up Python 3.12
      if: steps.changes.outputs.code_changed == 'true'
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
      with:
        python-version: '3.12.x'

    - name: Create virtual environment
      if: steps.changes.outputs.code_changed == 'true'
      run: |
        python -m venv .venv
        echo "Virtual environment created"

    - name: Run Minimal QC Gate
      if: steps.changes.outputs.code_changed == 'true'
      id: gate
      run: |
        source .venv/bin/activate
        ./scripts/devon_qc.sh --gate-only

    - name: Report Gate Success
      if: success() && steps.changes.outputs.code_changed == 'true'
      run: |
        printf 'QC Gate Passed\n'
        echo ""
        echo "Basic sanity checks validated:"
        echo "  - Dependencies install successfully"
        echo "  - Python imports work"
        echo "  - Tests are runnable"
        echo ""
        echo "Note: Full QC validation (coverage, lint) runs in qc-full job"

  qc-full:
    name: QC Full Validation (Non-Required - Coverage + Lint)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
    - name: Checkout repository
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
      with:
        fetch-depth: 0

    - name: Set up Python 3.12
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
      with:
        python-version: '3.12.x'

    - name: Create virtual environment
      run: |
        python -m venv .venv
        echo "Virtual environment created"

    - name: Run Full DevOnboarder QC
      id: qc
      run: |
        source .venv/bin/activate
        ./scripts/devon_qc.sh
      continue-on-error: true

    - name: Report QC failure
      if: steps.qc.outcome == 'failure'
      run: |
        printf 'WARNING: DevOnboarder Full QC Failed (Non-Blocking)\n'
        echo ""
        echo "This check validates comprehensive quality standards:"
        echo "  - Backend coverage: >=96%"
        echo "  - Bot coverage: 100%"
        echo "  - Frontend coverage: 100%"
        echo "  - YAML lint passing"
        echo "  - All tests: PASS"
        echo ""
        printf 'WARNING: This is a v4 hardening target, not a v3 blocker\n'
        echo "Issues identified here should be tracked for future cleanup"
        echo ""
        echo "Run locally to debug:"
        echo "  cd ecosystem/DevOnboarder"
        echo "  source .venv/bin/activate"
        echo "  bash scripts/devon_qc.sh"

    - name: Report QC success
      if: steps.qc.outcome == 'success'
      run: |
        printf 'DevOnboarder Full QC Passed\n'
        echo ""
        echo "Quality gates validated:"
        echo "  - Coverage thresholds met"
        echo "  - All tests passing"
        echo "  - No critical issues"

    - name: Upload coverage reports (if available)
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # TAGS-SHA-PIN: actions/upload-artifact@v5.0.0 (2025-10-24)
      with:
        name: coverage-reports
        path: |
          backend/htmlcov/
          bot/htmlcov/
          frontend/coverage/
        if-no-files-found: ignore

  lint-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .
    steps:
    - name: Checkout repository
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)

    - name: Set up Python 3.12
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
      with:
        python-version: '3.12.x'

    - name: Create virtual environment
      run: |
        python -m venv .venv

    - name: Install dev dependencies
      run: |
        source .venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Run flake8
      run: |
        source .venv/bin/activate
        flake8 backend/ bot/ scripts/ || true

    - name: Run black check
      run: |
        source .venv/bin/activate
        black --check backend/ bot/ scripts/ || true

    - name: Run isort check
      run: |
        source .venv/bin/activate
        isort --check-only backend/ bot/ scripts/ || true
