name: troubleshooting-harvest

on:
   workflow_dispatch:
   schedule:
      - cron: "0 8 * * *"  # daily at 08:00 UTC (optional)

permissions:
   contents: read
   actions: read
   checks: write

jobs:
   token-diagnostics:
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd

         - name: Print GH token context
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           run: |
              echo "GITHUB_TOKEN available: ${GITHUB_TOKEN:+yes}"
              echo "Repository: ${{ github.repository }}"
              echo "Actor: ${{ github.actor }}"

         - name: Inspect GITHUB_TOKEN scopes
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           run: |
              set -euo pipefail
              echo "Inspecting GITHUB_TOKEN scopes via API headers..."
              if [ -n "${GITHUB_TOKEN:-}" ]; then
                curl -sI -H "Authorization: token ${GITHUB_TOKEN}" https://api.github.com/ | \
                  tr -d '\r' | grep -i '^x-oauth-scopes:' || echo "No scopes header found"
              else
                echo "GITHUB_TOKEN not available"
              fi

         - name: Inspect AAR_TOKEN (if provided)
           env:
              AAR_TOKEN: ${{ secrets.AAR_TOKEN }}
           run: |
              set -euo pipefail
              if [ -n "${AAR_TOKEN:-}" ]; then
                echo "AAR_TOKEN present. Checking scopes and validity..."
                # Show a compact JSON error or header
                curl -sS -I -H "Authorization: token ${AAR_TOKEN}" https://api.github.com/ | \
                  tr -d '\r' | grep -i '^x-oauth-scopes:' || echo "No scopes header found"
                echo "Attempt a lightweight API probe (rate-limited):"
                curl -sS -H "Authorization: token ${AAR_TOKEN}" https://api.github.com/ | jq -r '.message // "API accessible"' || echo "API probe failed"
              else
                echo "AAR_TOKEN not available - using GITHUB_TOKEN for diagnostics"
                echo "Note: Some AAR features may be limited without AAR_TOKEN"
              fi

         - name: Safe-run diagnostics script (no-op)
           run: |
              echo "Diagnostics harvested. If AAR_TOKEN returned 401/Bad credentials, rotate the token and ensure 'repo' and 'workflow' scopes are present."
