# ---
# codex-agent:
#   name: Agent.SecurityAudit
#   role: Generates weekly dependency and code audit reports
#   scope: .github/workflows/security-audit.yml
#   triggers: Scheduled run or manual dispatch
#   output: Uploaded security audit report
# ---
name: Security Audit

on:
    schedule:
        - cron: "0 0 * * 0"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            
            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'
            
            - name: Install yamllint
              run: pip install yamllint==1.35.1
            
            - name: Lint YAML files
              run: yamllint -c .github/.yamllint-config '.github/workflows/**/*.yml'
    audit:
        needs: validate-yaml
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            - name: Install GitHub CLI
              uses: ./.github/actions/setup-gh-cli
              with:
                  version: stable
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Show gh version
              run: which gh && gh --version
            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: "3.12"
            - name: Set up Node
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # TAGS-SHA-PIN: actions/setup-node@v6.1.0 (2025-12-03)
              with:
                  node-version: "22"
            - name: Install Python dependencies
              run: |
                  pip install '.[test]'
                  pip install -e .
                  pip install pip-audit
            - name: Install frontend dependencies
              run: npm ci
              working-directory: frontend
            - name: Install bot dependencies
              run: npm ci
              working-directory: bot
            - name: Run security audit
              id: audit
              run: |
                  bash scripts/security_audit.sh

                  # Safe output assignment - use date directly
                  printf -- "report=docs/security-audit-%s.md\n" "$(date -I)" >> "$GITHUB_OUTPUT"
            - name: Upload audit report
              if: always()
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # TAGS-SHA-PIN: actions/upload-artifact@v5.0.0 (2025-10-24)
              with:
                  name: security-audit
                  path: ${{ steps.audit.outputs.report }}
                  retention-days: 7
