name: Automated Code Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review-bot:
    runs-on: ubuntu-latest
    name: Automated Terminal Policy Review

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for terminal policy violations
        id: violation-check
        run: |
          echo "Scanning PR for terminal output policy violations"

          VIOLATIONS=0

          # Get changed workflow files
          git diff --name-only origin/main...HEAD | grep -E '\.github/workflows/.*\.ya?ml$' > changed_workflows.txt || true

          if [ -s changed_workflows.txt ]; then
            echo "Checking workflow files for violations:"
            cat changed_workflows.txt

            while IFS= read -r file; do
              echo "Checking file: $file"

              # Check for emojis in ADDED lines only (lines starting with +)
              # Define emoji pattern for detection using Unicode ranges (safe for terminal output policy)
              EMOJI_PATTERN='\x{1F600}-\x{1F64F}|\x{1F300}-\x{1F5FF}|\x{1F680}-\x{1F6FF}'
              EMOJI_PATTERN="${EMOJI_PATTERN}|\x{2600}-\x{26FF}|\x{2700}-\x{27BF}|\x{1F44C}"
              EMOJI_PATTERN="${EMOJI_PATTERN}|\x{274C}|\x{1F4CB}|\x{1F50D}|\x{26A0}|\x{1F50D}"
              EMOJI_PATTERN="${EMOJI_PATTERN}|\x{1F4DD}|\x{1F680}|\x{1F4CB}|\x{1F50D}|\x{1F4DD}"

              if git diff origin/main...HEAD -- "$file" | grep '^+' | grep -P "$EMOJI_PATTERN" 2>/dev/null; then
                VIOLATIONS=$((VIOLATIONS + 1))
                {
                  echo "- Emoji/Unicode in $file (causes terminal hanging)"
                } >> violation_details.txt
              fi

              # Check for command substitution in echo in ADDED lines only
              if git diff origin/main...HEAD -- "$file" | grep '^+' | grep -E 'echo.*\$\(' 2>/dev/null; then
                VIOLATIONS=$((VIOLATIONS + 1))
                {
                  echo "- Command substitution in echo in $file (causes terminal hanging)"
                } >> violation_details.txt
              fi

              # Check for variable expansion in echo in ADDED lines only
              if git diff origin/main...HEAD -- "$file" | grep '^+' | grep -E 'echo.*\$[A-Z_][A-Z0-9_]*' 2>/dev/null; then
                VIOLATIONS=$((VIOLATIONS + 1))
                {
                  echo "- Variable expansion in echo in $file (can cause terminal hanging)"
                } >> violation_details.txt
              fi

            done < changed_workflows.txt
          fi

          # Output results to GitHub Actions
          echo "violations=$VIOLATIONS" >> "$GITHUB_OUTPUT"

          # Output details to GitHub Actions
          if [ -f violation_details.txt ]; then
            {
              echo "details="
              cat violation_details.txt
              echo ""
            } >> "$GITHUB_OUTPUT"
          else
            echo "details=" >> "$GITHUB_OUTPUT"
          fi

      - name: Auto-reject PR for violations
        if: steps.violation-check.outputs.violations != '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "BLOCKING PR: Terminal output policy violations detected"

          # Create rejection comment using safe file approach
          {
            echo "**AUTOMATED REJECTION: Terminal Output Policy Violations**"
            echo ""
            echo "This PR has been automatically rejected due to critical terminal output violations that WILL cause system hanging."
            echo ""
            echo "**Violations Detected:**"
          } > rejection_comment.md

          # Safe violation details output - avoid multi-line expansion
          if [ -f violation_details.txt ]; then
            cat violation_details.txt >> rejection_comment.md
          fi

          {
            echo ""
            echo "**Required Before Re-submission:**"
            echo "1. Remove ALL emojis from workflow files"
            echo "2. Replace command substitution in echo with separate commands"
            echo "3. Use individual echo statements with plain ASCII text only"
            echo "4. Review docs/TERMINAL_OUTPUT_VIOLATIONS.md for approved patterns"
            echo "5. Run local validation: bash scripts/validate_terminal_output.sh"
            echo ""
            echo "**Policy Reminder:** DevOnboarder has ZERO TOLERANCE for these violations because they cause immediate system failures."
            echo ""
            echo "**Next Steps:**"
            echo "- Fix all violations"
            echo "- Validate locally with the enforcement script"
            echo "- Push updates to trigger re-review"
          } >> rejection_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file rejection_comment.md

          # Request changes through review
          gh pr review ${{ github.event.pull_request.number }} --request-changes --body "AUTOMATED REJECTION: Critical terminal output policy violations detected. See comment for details."

      - name: Add enforcement checklist
        if: steps.violation-check.outputs.violations == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Adding enforcement checklist to compliant PR"

          # Create checklist comment using safe file approach
          {
            echo "**Terminal Output Policy Compliance Verified**"
            echo ""
            echo "Automated review confirms this PR follows DevOnboarder terminal output standards."
            echo ""
            echo "**Automated Compliance Verification:**"
            echo "- [x] No emojis or Unicode characters in terminal output"
            echo "- [x] No command substitution in echo statements"
            echo "- [x] No variable expansion in echo statements"
            echo "- [x] Only individual echo commands with plain ASCII text"
            echo "- [x] Complex output uses file-based patterns (individual echo statements)"
            echo ""
            echo "**Policy Compliance Status: VERIFIED**"
            echo "This PR has been automatically validated and meets all DevOnboarder terminal output standards."
          } > checklist_comment.md

          gh pr comment ${{ github.event.pull_request.number }} --body-file checklist_comment.md

      - name: Log review results
        run: |
          echo "Code review bot results:"
          echo "Violations found:"
          echo "Count:"
          echo "${{ steps.violation-check.outputs.violations }}"
          echo "PR action determined:"
          echo "Action:"
          if [ "${{ steps.violation-check.outputs.violations }}" != '0' ]; then
            echo "REJECTED"
          else
            echo "APPROVED"
          fi
          echo "Enforcement level: ZERO TOLERANCE"
