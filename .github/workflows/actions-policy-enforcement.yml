name: Actions Policy Enforcement

# Purpose: Block banned third-party actions and enforce SHA pinning
# Scope: All workflow files in .github/workflows/
# Policy: ACTIONS_POLICY.md (TAGS-META)
# Reference: tags-qa-framework/docs/ACTIONS_REPLACEMENT_MATRIX.md
#
# IMPORTANT: This workflow ALWAYS runs on PRs (no path filter) to ensure
# the required check context is created. Non-workflow PRs get a fast noop success.
# This prevents branch protection bypass for docs-only changes.

on:
  push:
    branches: [main, master, develop]
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'
  pull_request:
    # NOTE: No paths filter - always run to provide required check context

jobs:
  validate-actions-policy:
    name: Validate Actions Policy Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
        with:
          fetch-depth: 0

      - name: Detect workflow changes
        id: changes
        run: |
          # Detect if workflow files changed (vs non-workflow PR)
          # Compare against base branch for PRs, or HEAD~1 for pushes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
          else
            BASE="HEAD~1"
          fi

          # Check for workflow changes
          WORKFLOW_CHANGED="false"
          if git diff --name-only "$BASE" HEAD 2>/dev/null | grep -qE "^\.github/workflows/.*\.(yml|yaml)$"; then
            WORKFLOW_CHANGED="true"
          fi

          echo "workflow_changed=$WORKFLOW_CHANGED" >> $GITHUB_OUTPUT
          echo "Workflow files changed: $WORKFLOW_CHANGED"

          if [ "$WORKFLOW_CHANGED" = "false" ]; then
            echo ""
            echo "No workflow changes detected - non-workflow PR"
            echo "Actions Policy check will pass with noop success"
          fi

      - name: Noop success for non-workflow PR
        if: steps.changes.outputs.workflow_changed == 'false'
        run: |
          echo ""
          echo "=========================================="
          echo "ACTIONS POLICY: NON-WORKFLOW PR (NOOP SUCCESS)"
          echo "=========================================="
          echo ""
          echo "No workflow file changes detected in this PR."
          echo "Skipping actions policy validation."
          echo ""
          echo "Changed paths do not include:"
          echo "  - .github/workflows/**/*.yml"
          echo "  - .github/workflows/**/*.yaml"
          echo ""
          echo "Actions Policy check passes automatically for non-workflow PRs."
          echo ""

      - name: Check for banned third-party actions
        if: steps.changes.outputs.workflow_changed == 'true'
        id: check-banned
        run: |
          echo "Checking for banned third-party actions..."
          BANNED_FOUND=false

          # List of explicitly banned actions
          BANNED_ACTIONS=(
            "DavidAnson/markdownlint-cli2-action"
            "dorny/paths-filter"
            "ibiqlik/action-yamllint"
            "peter-evans/create-pull-request"
          )

          # Check each banned action
          for action in "${BANNED_ACTIONS[@]}"; do
            if grep -r "uses:.*${action}" .github/workflows/ 2>/dev/null; then
              printf 'ERROR: Banned action detected: %s\n' "${action}"
              echo ""
              echo "This action is explicitly forbidden by v3 policy."
              echo "See ACTIONS_REPLACEMENT_MATRIX.md for approved replacement."
              echo ""
              BANNED_FOUND=true
            fi
          done

          if [ "$BANNED_FOUND" = "true" ]; then
            echo "banned_detected=true" >> $GITHUB_OUTPUT
          else
            echo "No explicitly banned actions detected"
            echo "banned_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for non-allowlisted action owners
        if: steps.changes.outputs.workflow_changed == 'true'
        id: check-owners
        run: |
          echo "Checking for non-allowlisted action owners..."
          VIOLATIONS_FOUND=false

          # Extract all action references (exclude comments)
          ACTION_REFS=$(grep -rhE "^\s*uses:\s+" .github/workflows/ 2>/dev/null | \
                        grep -v "^\s*#" | \
                        sed 's/^\s*uses:\s*//' | \
                        sort -u)

          # Check each reference
          while IFS= read -r ref; do
            # Skip empty lines
            [ -z "$ref" ] && continue

            # Extract owner (part before first /)
            owner=$(echo "$ref" | cut -d'/' -f1)

            # Check if owner is allowlisted
            if [[ "$owner" != "actions" && "$owner" != "docker" && "$owner" != "." ]]; then
              printf 'ERROR: Non-allowlisted action owner: %s\n' "${owner}"
              printf '   Full reference: %s\n' "${ref}"
              echo ""
              echo "Only 'actions/*' and 'docker/*' actions are allowed by v3 policy."
              echo "Third-party actions must be replaced with first-party + scripts."
              echo ""
              VIOLATIONS_FOUND=true
            fi
          done <<< "$ACTION_REFS"

          if [ "$VIOLATIONS_FOUND" = "true" ]; then
            echo "violations_detected=true" >> $GITHUB_OUTPUT
          else
            echo "All action owners are allowlisted (actions/* or docker/*)"
            echo "violations_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Check SHA pinning compliance
        if: steps.changes.outputs.workflow_changed == 'true'
        id: check-sha
        run: |
          echo "Checking SHA pinning compliance..."
          TAG_REFS_FOUND=false

          # Check for tag-based references (not SHA-pinned)
          # Pattern: actions/something@v1 or actions/something@main (not 40-char SHA)
          # Updated pattern ensures exactly 40 hex chars required (prevents false positives from echo examples)
          TAG_REFS=$(grep -rhE "uses:\s+(actions|docker)/[^@]+@" .github/workflows/ 2>/dev/null | \
                     grep -v "^\s*#" | \
                     grep -vE "^\s*(echo|#.*echo)" | \
                     grep -vE "@[a-f0-9]{40}" || true)

          if [ -n "$TAG_REFS" ]; then
            echo "ERROR: Tag-based action references detected:"
            echo ""
            printf '%s\n' "$TAG_REFS"
            echo ""
            echo "All actions must be pinned to full 40-char commit SHA."
            echo "Format: uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)"
            echo ""
            TAG_REFS_FOUND=true
          fi

          if [ "$TAG_REFS_FOUND" = "true" ]; then
            echo "tag_refs_detected=true" >> $GITHUB_OUTPUT
          else
            echo "All actions are SHA-pinned (no tag-based references)"
            echo "tag_refs_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Report policy violations
        if: |
          steps.changes.outputs.workflow_changed == 'true' &&
          (steps.check-banned.outputs.banned_detected == 'true' ||
          steps.check-owners.outputs.violations_detected == 'true' ||
          steps.check-sha.outputs.tag_refs_detected == 'true')
        run: |
          echo ""
          echo "=========================================="
          echo "ACTIONS POLICY VIOLATIONS DETECTED"
          echo "=========================================="
          echo ""
          echo "Your workflow changes violate v3 Actions Policy."
          echo ""
          echo "Required Actions:"
          echo "1. Review ACTIONS_POLICY.md for policy details"
          echo "2. Consult tags-qa-framework/docs/ACTIONS_REPLACEMENT_MATRIX.md"
          echo "3. Replace banned actions with approved alternatives"
          echo "4. Ensure all actions are SHA-pinned to 40-char commit hash"
          echo "5. Verify action owners are 'actions/*' or 'docker/*' only"
          echo ""
          echo "Policy Enforcement:"
          echo "- Banned actions: Explicitly forbidden by name"
          echo "- Non-allowlisted owners: Only GitHub (actions/*) and Docker (docker/*) allowed"
          echo "- Tag-based refs: Must use full SHA, not tags like @v4"
          echo ""
          echo "This check will fail until all violations are resolved."
          echo ""
          exit 1

      - name: Policy compliance confirmed
        if: |
          steps.changes.outputs.workflow_changed == 'true' &&
          steps.check-banned.outputs.banned_detected != 'true' &&
          steps.check-owners.outputs.violations_detected != 'true' &&
          steps.check-sha.outputs.tag_refs_detected != 'true'
        run: |
          echo ""
          echo "=========================================="
          echo "ACTIONS POLICY COMPLIANCE CONFIRMED"
          echo "=========================================="
          echo ""
          echo "All workflow changes comply with v3 Actions Policy:"
          echo "  - No banned third-party actions detected"
          echo "  - All action owners are allowlisted (actions/* or docker/*)"
          echo "  - All actions are SHA-pinned (no tag-based references)"
          echo ""
          echo "Policy enforcement layers:"
          echo "  - This CI job (detects violations at commit time)"
          echo "  - GitHub org settings (blocks non-GitHub actions)"
          echo "  - MCP governance layer (SHA age window + audit)"
          echo ""
