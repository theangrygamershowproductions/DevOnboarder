# ---
# codex-agent:
#   name: Agent.EnvDocAlignment
#   role: Ensures environment docs stay in sync with code
#   scope: .github/workflows/env-doc-alignment.yml
#   triggers: CI workflow failures on env doc checks
#   output: Issue listing missing variables
#   security: Uses workflow_run trigger with trusted code checkout only
# ---
# SECURITY: This workflow uses workflow_run trigger which runs in privileged context.
# It intentionally does NOT checkout untrusted PR code to prevent code execution attacks.
# Only trusted code from the default branch is used for documentation validation.
name: Env Doc Alignment

on:
    workflow_run:
        workflows: ["CI"]
        types:
            - completed

permissions:
    contents: read
    issues: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            
            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'
            
            - name: Install yamllint
              run: pip install yamllint==1.35.1
            
            - name: Lint YAML files
              run: yamllint -c .github/.yamllint-config '.github/workflows/**/*.yml'
    audit:
        needs: validate-yaml
        if: github.event.workflow_run.conclusion == 'failure'
        runs-on: ubuntu-latest
        steps:
            # Security: workflow_run trigger executes in privileged context.
            # NEVER checkout PR head code - only use default branch (trusted code).
            # This prevents code injection attacks from untrusted forks.
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
              with:
                  fetch-depth: 0
                  # Explicitly omit 'ref' parameter to ensure default branch checkout
                  # Do NOT use github.event.pull_request.head.sha (untrusted)
                  # Do NOT use github.event.workflow_run.head_sha (untrusted)
            - name: Get workflow run information
              id: workflow-info
              run: |
                  # Safely capture workflow run details without checking out untrusted code
                  printf "head_sha=%s\n" "${{ github.event.workflow_run.head_sha || github.sha }}" >> "$GITHUB_OUTPUT"
            - name: Install GitHub CLI
              uses: ./.github/actions/setup-gh-cli
              with:
                  version: stable
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Show gh version
              run: which gh && gh --version
            - name: Validate env docs
              id: check
              run: |
                  python scripts/check_env_docs.py > env_docs.log && printf "success=true\n" >> "$GITHUB_OUTPUT" || printf "success=false\n" >> "$GITHUB_OUTPUT"
                  cat env_docs.log
            - name: Parse missing variables
              if: steps.check.outputs.success == 'false'
              id: vars
              run: |
                  missing=$(awk '/^Variables missing from agents\/index.md:/{flag=1;next}/^$/{flag=0}flag' env_docs.log | tr '\n' ',' | sed 's/,$//')
                  printf "missing=%s\n" "$missing" >> "$GITHUB_OUTPUT"
            - name: Install PyYAML
              if: steps.check.outputs.success == 'false'
              run: pip install PyYAML
            - name: Verify bot permission
              if: steps.check.outputs.success == 'false'
              run: 'bash scripts/validate-bot-permissions.sh'
            - name: Create issue
              if: steps.check.outputs.success == 'false'
              run: |
                  cat > body.md <<'BODY'
                    ## Missing variables
                    ${{ steps.vars.outputs.missing }}

                    - [ ] I manually reviewed the variables against [agents/index.md](../../agents/index.md)
                  BODY
                  jq -Rs --arg title "Secrets misaligned in docs for ${{ steps.workflow-info.outputs.head_sha }}" '{title:$title,body:.}' body.md > notify.json
                  gh workflow run notify.yml -f data="$(cat notify.json)"
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
