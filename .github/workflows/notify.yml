# ---
# codex-agent:
#   name: Agent.Notify
#   role: Aggregates human notifications from other workflows
#   scope: .github/workflows/notify.yml
#   triggers: Manual dispatch
#   output: Comment on operations issue
# ---
name: Notify

on:
    workflow_dispatch:
        inputs:
            data:
                description: JSON payload with title and body
                required: true

permissions:
    issues: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            
            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'
            
            - name: Install yamllint
              run: pip install yamllint==1.35.1
            
            - name: Lint YAML files
              run: yamllint -c .github/.yamllint-config '.github/workflows/**/*.yml'
    process:
        needs: validate-yaml
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            - name: Install GitHub CLI
              uses: ./.github/actions/setup-gh-cli
              with:
                  version: stable
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Show gh version
              run: which gh && gh --version
            - name: Install PyYAML
              run: pip install PyYAML
            - name: Validate orchestration bot permissions
              run: 'bash scripts/validate-bot-permissions.sh'
            - name: Process notification
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  PAYLOAD: ${{ inputs.data }}
              run: |
                  printf '%s\n' "$PAYLOAD" > notify.json
                  python scripts/process_notifications.py notify.json
