---
# codex-agent:
#   name: Agent.ValidatePermissions
#   role: Lints workflow files and bot permissions
#   scope: .github/workflows/validate-permissions.yml
#   triggers: Push and pull_request events
#   output: CI logs
# ---
name: Validate Permissions

on:
    push: null
    pull_request: null

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read
    pull-requests: write

jobs:
    validate-yaml:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # TAGS-SHA-PIN: actions/setup-python@v6.1.0 (2025-11-24)
              with:
                  python-version: '3.12'

            - name: Install yamllint
              run: pip install yamllint==1.35.1

            - name: Lint YAML files
              run: yamllint -c .github/.yamllint-config .github/workflows/**/*.yml
    check:
        needs: validate-yaml
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # TAGS-SHA-PIN: actions/checkout@v5.0.1 (2025-11-13)
            - name: Install yamllint
              run: pip install yamllint==1.35.1
            - name: Lint bot permissions
              run: bash scripts/lint-bot-permissions.sh
            - name: Verify agent docs exist
              run: |
                  test -f agents/index.md
                  test -f agents/templates/Agent.md
            - name: Check for disallowed commands
              run: |
                  if grep -R "gh issue" .github/workflows | \
                      grep -v validate-permissions.yml; then
                    echo "Direct gh issue command found" >&2
                    exit 1
                  fi
                  if grep -R "notify-humans.sh" .github/workflows | \
                      grep -v validate-permissions.yml; then
                    echo "External notification script used" >&2
                    exit 1
                  fi
                  if grep -R "hooks.slack.com" .github/workflows | \
                      grep -v validate-permissions.yml; then
                    echo "Direct Slack notification found" >&2
                    exit 1
                  fi
            - name: Ensure continuous improvement checklist is complete
              if: github.event_name == 'pull_request'
              run: |
                  if grep -q "- \\\[ \\\]" \
                      docs/checklists/continuous-improvement.md; then
                    echo "Unchecked items in continuous-improvement.md" >&2
                    exit 1
                  fi
            - name: Validate PR checklist
              if: github.event_name == 'pull_request'
              run: >
                  bash scripts/validate_pr_checklist.sh
                  "${{ github.event.pull_request.number }}"
              env:
                  GH_TOKEN: ${{ secrets.BOT_PR_WRITE_TOKEN }}
