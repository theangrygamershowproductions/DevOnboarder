# CI Enforcement Tasks

This document outlines the automation checks Codex uses to keep the CI workflow consistent. Each section lists the CI step responsible and what reporting it produces.

## 1. Language Versions

- The main workflow tests Python **3.12** only and validates Node.js **20**.
- `scripts/check_versions.sh` verifies these versions locally and in CI.
- Results appear in the `Verify language versions` step log.

## 2. Workflow Linting

- `validate-yaml` lints `.github/workflows/**/*.yml` using the shared `.github/.yamllint-config` rules.
- The YAML log uploads as `yamllint.log` for troubleshooting when the job fails.

## 3. Dependency Checks

- `pip check` runs after installation and again once the package is installed.
- `pip-audit`, `bandit` and `npm audit --audit-level=high` fail the build on high severity issues.
- Local equivalents exist in `scripts/check_dependencies.sh` and `scripts/security_audit.sh`.

## 4. Coverage Gate

- Both Python and JavaScript tests must maintain **95%** coverage.
- `pytest --cov=src --cov-fail-under=95` enforces this requirement.
- The bot and frontend run `npm run coverage` with the same threshold.
- Coverage summaries post to pull requests via `scripts/append_coverage_summary.sh` and are saved as artifacts.

## 5. Commit Message Linting

- `scripts/check_commit_messages.sh` ensures messages follow the `<TYPE>(<scope>): <subject>` format.
- CI fails and annotates offending commits when the format is violated.

## 6. Documentation Linting

- `scripts/check_docs.sh` runs `markdownlint-cli2` and Vale.
- Results upload as the `vale-results` artifact and fail the build on errors.
- Contributors should also review [docs/bot-types.md](../docs/bot-types.md) to understand how the Discord bot differs from Codex agents.

## 7. CI Failure Handling

- `codex.ci.yml` monitors `ci.yml` for failures and attempts `ruff --fix` and `pre-commit run --files`.
- If the build still fails, the bot opens a `ci-failure` issue with logs and a short summary generated by `scripts/summarize_ci_failures.py`.
- Subsequent successful runs automatically close these issues.

## 8. Bot Orchestration

- All project bots must obey the permissions listed in `.codex/bot-permissions.yaml`.
- Only orchestrator bots may notify humans. Other bots operate quietly and record results in CI logs or artifacts.

## 9. Permissions Validation

- `scripts/validate-bot-permissions.sh` checks that each workflow token matches the policy in `.codex/bot-permissions.yaml`.
- Builds fail when a bot requests a scope that is not allowed.

## 10. Known-Error Handling

- `scripts/ci_failure_diagnoser.py` and `scripts/summarize_ci_failures.py` group recurring transient errors so maintainers can skip redundant investigations.
- Summaries are posted to the CI failure issue for reference.

## 11. Centralized Notifications

- All human notifications flow through `.github/workflows/notify.yml` using `gh workflow run notify.yml -f data=<json>`.
- The workflow aggregates messages via `scripts/process_notifications.py` and comments on the operations issue.

## 12. Agent Standards

- Documentation for each agent lives under `/agents` and begins with a `codex-agent` YAML header.
- Every agent must be listed in `.codex/agents/index.json` and permissions are defined in `.codex/bot-permissions.yaml`.
- CI regenerates environment variable tables with `scripts/regenerate_env_docs.py` and validates them with `scripts/check_env_docs.py`.

## 13. Bot Inventory

- Run `python scripts/list-bots.py` to list all bots found in `.github/workflows` and `.codex/agents/index.json`.
- The script reports any agents missing from `.codex/bot-permissions.yaml`.

## EnvVar Manager Integration

- EnvVar Manager agent audits all ENVARS used in code, workflows, and agent docs.
- Ensures .env.example files are present and correct in each project directory.
- Notifies through `.github/workflows/notify.yml`.
- Escalates via GitHub Issue if misalignment persists >24h.
- Follows agent doc at agents/envvar-manager.md.

## markdown/fix-style-violations

- Run `npx -y markdownlint-cli2 "**/*.md"` to lint every Markdown file.
- Address reported warnings or run `npx -y markdownlint-cli2 --fix "**/*.md"` for auto-fixable rules.
- Commit the changes with a `STYLE(markdown):` message describing the cleanup.
- Push the branch and open a pull request summarizing the style fixes.
